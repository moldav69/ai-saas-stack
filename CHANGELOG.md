# Changelog

All notable changes to this project will be documented in this file.

## [2.0.0] - 2026-02-17

### üî• Breaking Changes

- **Nginx Proxy Manager**: Downgraded to v2.11.3 from v2.12.6
  - v2.12.6 has critical bug with database migrations causing "502 Bad Gateway" on login
  - Existing NPM configurations will need to be recreated after upgrade
  - Database will be reset during upgrade process

- **AnythingLLM**: Removed `JWT_SECRET` and `ENCRYPTION_KEY` from `.env`
  - These values are now auto-generated by AnythingLLM during initial setup wizard
  - Setup wizard is now mandatory on first access
  - Existing installations will need to complete setup wizard after upgrade

### ‚ú® Features

- **Quick Fix Script**: Added `scripts/quick-fix-v2.sh` for automated upgrade
  - Automatic backup of existing configuration
  - Safe database reset for NPM and AnythingLLM
  - Preserves n8n workflows and data
  - Color-coded output for better UX

- **Health Checks**: Added Docker healthchecks for all services
  - NPM: checks port 81 availability
  - n8n: checks `/healthz` endpoint
  - AnythingLLM: checks `/api/ping` endpoint
  - Proper service dependencies with `condition: service_healthy`

- **n8n Configuration**: Fixed port configuration
  - Explicitly set `N8N_PORT=5678` in docker-compose.yml
  - Removes ambiguity and potential port conflicts

### üêõ Bug Fixes

- **NPM Login Issue**: Fixed "502 Bad Gateway" error when logging into Nginx Proxy Manager
  - Root cause: v2.12.6 missing migration file `20251111090000_redirect_auto_scheme.js`
  - Solution: downgrade to stable v2.11.3

- **AnythingLLM Wizard**: Fixed setup wizard not appearing
  - Root cause: `JWT_SECRET` in .env bypassed security wizard
  - Solution: removed JWT_SECRET from config, forcing secure setup

- **Docker Warnings**: Removed warnings about undefined environment variables
  - Cleaned up unused JWT_SECRET and ENCRYPTION_KEY references
  - Better .env.example documentation

### üìö Documentation

- **Updated .env.example**: Clear explanations for all variables
  - Added warnings about removed JWT variables
  - Step-by-step wizard instructions for AnythingLLM
  - Security best practices highlighted

- **Migration Guide**: Instructions for upgrading from v1.x
  - What will be preserved (n8n data, SSL certificates)
  - What will be reset (NPM config, AnythingLLM setup)
  - Step-by-step upgrade process

### üîí Security

- **Forced Setup Wizard**: AnythingLLM now requires secure initial configuration
  - Prevents unauthorized access with default credentials
  - Admin account must be created explicitly
  - JWT tokens generated securely internally

- **Better Secrets Management**: 
  - Removed hardcoded secrets from examples
  - Clear instructions for generating secure random keys
  - Telemetry disabled by default for privacy

### üõ†Ô∏è Maintenance

- **Version Pinning**: NPM now uses specific stable version (2.11.3)
  - Prevents automatic upgrades to buggy versions
  - Predictable behavior across deployments
  - Can be manually upgraded when 2.12.x is fixed

- **Improved Logging**: 
  - Log rotation configured (max 10MB, 3 files)
  - Prevents disk space issues from log bloat
  - Easier debugging with structured logs

---

## [1.0.0] - 2026-02-10

Initial release with:
- Nginx Proxy Manager 2.12.6 (later found buggy)
- n8n 2.7.5
- AnythingLLM latest
- Basic docker-compose setup
- Manual configuration required

---

## Migration from v1.x to v2.0

### What You'll Lose
- ‚ùå Nginx Proxy Manager proxy host configurations
- ‚ùå Nginx Proxy Manager SSL certificates (will need to request new ones)
- ‚ùå AnythingLLM workspaces and settings

### What You'll Keep
- ‚úÖ n8n workflows and credentials
- ‚úÖ n8n webhook URLs (no changes needed)
- ‚úÖ Docker network and volumes
- ‚úÖ Backup configurations

### Quick Upgrade

```bash
cd /opt/ai-saas-stack

# Download and run fix script
wget https://raw.githubusercontent.com/moldav69/ai-saas-stack/v2.0-stable-fix/scripts/quick-fix-v2.sh
chmod +x quick-fix-v2.sh
./quick-fix-v2.sh
```

### Manual Steps After Upgrade

1. **Reconfigure Nginx Proxy Manager** (http://YOUR_IP:81)
   - Login: `admin@example.com` / `changeme`
   - Create proxy hosts for n8n and AnythingLLM
   - Request new SSL certificates

2. **Complete AnythingLLM Setup** (https://llm.yourdomain.com)
   - Create admin account
   - Choose LLM provider
   - Configure embedding model
   - Create workspaces

3. **Verify n8n** (https://n8n.yourdomain.com)
   - Check all workflows still work
   - Test webhooks
   - Verify credentials

---

## Support

If you encounter issues:
1. Check [TROUBLESHOOTING.md](TROUBLESHOOTING.md)
2. Review Docker logs: `docker compose logs -f`
3. Open an issue on GitHub with full error logs
